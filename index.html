<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets 食譜管理系統 - 連接問題解決</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "微軟正黑體", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #fff8f0 0%, #f9e5d2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #d2691e, #a0522d);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #fffaf3;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #d2691e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3d6b4;
        }
        
        h3 {
            color: #a0522d;
            margin: 15px 0 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #8b4513;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d2691e;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .name {
            flex: 1.5;
        }
        
        .ingredient-row .weight {
            flex: 1;
        }
        
        .ingredient-row .percent {
            flex: 1;
            background-color: #f5f5f5;
        }
        
        .ingredient-row .desc {
            flex: 1.5;
        }
        
        .ingredient-row .remove {
            flex: 0.3;
            text-align: center;
            color: #a0522d;
            cursor: pointer;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            background-color: #d2691e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #a0522d;
        }
        
        button.secondary {
            background-color: #8b8b8b;
        }
        
        button.secondary:hover {
            background-color: #6b6b6b;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        button.danger {
            background-color: #dc3545;
        }
        
        button.danger:hover {
            background-color: #c82333;
        }
        
        .recipe-list {
            margin-top: 20px;
        }
        
        .recipe-card {
            border: 1px solid #d2691e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .recipe-title {
            color: #d2691e;
            font-size: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #d2691e;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f3d6b4;
        }
        
        .steps {
            white-space: pre-line;
            line-height: 1.8;
            background: #fffaf3;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d2691e;
        }
        
        .instructions {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 5px solid #4a90e2;
        }
        
        .instructions h2 {
            color: #4a90e2;
            border-bottom: 2px solid #a7c7e7;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        .alert.success {
            background: #e6fffa;
            border-left: 4px solid #00b894;
        }
        
        .alert.error {
            background: #ffe6e6;
            border-left: 4px solid #ff4757;
        }
        
        .alert.warning {
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        .alert.info {
            background: #e6f3ff;
            border-left: 4px solid #4a90e2;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #d2691e;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f3d6b4;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: #d2691e;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .webapp-url {
            font-family: monospace;
            background: #f1f3f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .debug-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .solution-steps {
            background: #f8fff9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .solution-step {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .solution-step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: #28a745;
            color: white;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .ingredient-row > * {
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Google Sheets 食譜管理系統</h1>
            <p class="subtitle">連接問題解決與診斷工具</p>
        </header>
        
        <div class="content">
            <div class="alert warning">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>檢測到連接問題：</strong> 您的Google Apps Script Web App URL無法正常連接，錯誤訊息：Load failed
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="fix">修復連接問題</div>
                    <div class="tab" data-tab="app">食譜管理</div>
                    <div class="tab" data-tab="debug">除錯資訊</div>
                </div>
                
                <div class="tab-content active" id="fix">
                    <h2>Google Sheets 連接問題修復指南</h2>
                    
                    <div class="solution-steps">
                        <h3>請按照以下步驟解決連接問題：</h3>
                        
                        <div class="solution-step">
                            <span class="solution-step-number">1</span>
                            <strong>檢查Google Apps Script部署設置</strong>
                            <p>確保您的Apps Script已正確部署為"網頁應用程式"，並且權限設置為"任何人"。</p>
                            <button class="secondary" onclick="openInNewTab('https://script.google.com')">
                                <i class="fas fa-external-link-alt"></i> 打開Google Apps Script
                            </button>
                        </div>
                        
                        <div class="solution-step">
                            <span class="solution-step-number">2</span>
                            <strong>驗證Web App URL</strong>
                            <p>確認您的Web App URL是否正確。當前設置的URL是：</p>
                            <div class="webapp-url" id="current-url">https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec</div>
                            <p>點擊下方按鈕測試此URL是否有效：</p>
                            <button id="test-url" class="success">
                                <i class="fas fa-plug"></i> 測試URL有效性
                            </button>
                            <div id="url-test-result" class="alert" style="display: none; margin-top: 10px;">
                                <i class="fas fa-spinner fa-spin"></i> 測試中...
                            </div>
                        </div>
                        
                        <div class="solution-step">
                            <span class="solution-step-number">3</span>
                            <strong>重新部署Apps Script</strong>
                            <p>如果URL無效，請嘗試重新部署Apps Script並獲取新的URL：</p>
                            <ol>
                                <li>打開您的Google Apps Script項目</li>
                                <li>點擊"部署" > "新增部署"</li>
                                <li>選擇"網頁應用程式"</li>
                                <li>設置執行身份為"我"，權限為"任何人"</li>
                                <li>點擊"部署"並複製新的URL</li>
                                <li>將新URL貼到下方的輸入框中</li>
                            </ol>
                            
                            <div class="form-group">
                                <label for="new-webapp-url">新的Web App URL</label>
                                <input type="text" id="new-webapp-url" placeholder="https://script.google.com/macros/s/..." />
                                <button id="save-new-url" class="success" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i> 保存新URL
                                </button>
                            </div>
                        </div>
                        
                        <div class="solution-step">
                            <span class="solution-step-number">4</span>
                            <strong>檢查Google Sheets權限</strong>
                            <p>確保您的Google Sheets文件已設置為"任何人擁有連結者均可編輯"：</p>
                            <button class="secondary" onclick="openInNewTab('https://docs.google.com/spreadsheets')">
                                <i class="fas fa-external-link-alt"></i> 打開Google Sheets
                            </button>
                        </div>
                        
                        <div class="solution-step">
                            <span class="solution-step-number">5</span>
                            <strong>使用本地模式</strong>
                            <p>如果無法解決Google Sheets連接問題，您可以暫時使用本地模式保存食譜：</p>
                            <button id="enable-local-mode" class="secondary">
                                <i class="fas fa-database"></i> 啟用本地模式
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>提示：</strong> 完成上述步驟後，請點擊"測試URL有效性"按鈕確認問題是否已解決。
                    </div>
                </div>
                
                <div class="tab-content" id="app">
                    <h2>食譜管理</h2>
                    
                    <div id="connection-status" class="alert warning">
                        <i class="fas fa-exclamation-triangle"></i> 目前處於離線模式，食譜將保存在本地瀏覽器中
                    </div>
                    
                    <div class="form-group">
                        <label for="title">食譜名稱</label>
                        <input type="text" id="title" placeholder="例如：經典牛奶吐司" required>
                    </div>
                    
                    <div class="form-group">
                        <label>食材明細（重量單位：克；百分比以麵粉為基數）</label>
                        <div id="ingredients-container">
                            <!-- 食材行將通過JavaScript動態添加 -->
                        </div>
                        <button type="button" id="add-ingredient" class="secondary">
                            <i class="fas fa-plus"></i> 新增食材
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="steps">做法步驟</label>
                        <textarea id="steps" placeholder="請詳細描述製作步驟..." required></textarea>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" id="save-recipe">
                            <i class="fas fa-save"></i> 新增食譜
                        </button>
                        <button type="button" id="load-recipes" class="secondary">
                            <i class="fas fa-sync"></i> 重新載入食譜
                        </button>
                        <button type="button" id="reset-form" class="secondary">
                            <i class="fas fa-redo"></i> 重設表單
                        </button>
                        <button type="button" id="export-data" class="success">
                            <i class="fas fa-download"></i> 導出數據
                        </button>
                    </div>
                    
                    <div class="section">
                        <h2>食譜列表</h2>
                        <div id="recipe-list" class="recipe-list">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="debug">
                    <h2>除錯資訊</h2>
                    
                    <div class="alert">
                        <i class="fas fa-bug"></i> 連接問題診斷資訊
                    </div>
                    
                    <div class="buttons">
                        <button id="test-connection" class="secondary">
                            <i class="fas fa-plug"></i> 測試Google連接
                        </button>
                        <button id="view-localstorage" class="secondary">
                            <i class="fas fa-database"></i> 查看本地數據
                        </button>
                        <button id="clear-data" class="danger">
                            <i class="fas fa-trash"></i> 清除所有數據
                        </button>
                    </div>
                    
                    <div class="debug-panel">
                        <div class="debug-title">
                            <h3>診斷日誌</h3>
                            <button id="clear-log" class="button-small">清除日誌</button>
                        </div>
                        <div id="debug-log">
                            <div>[系統啟動] 食譜管理系統已加載</div>
                            <div>[錯誤] Google Sheets連接失敗: Load failed</div>
                            <div>[信息] 已啟用本地模式，數據將保存在瀏覽器中</div>
                        </div>
                    </div>
                    
                    <div class="config-panel">
                        <h3>當前配置</h3>
                        <p><strong>Web App URL:</strong> <span id="config-url">https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec</span></p>
                        <p><strong>模式:</strong> <span id="config-mode">本地模式</span></p>
                        <p><strong>食譜數量:</strong> <span id="recipe-count">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 食材選項
            const ingredientOptions = [
                "麵粉", "水", "糖", "酵母", "牛奶", "奶粉", "煉乳",
                "雞蛋", "優格", "其他"
            ];
            
            // Web App URL
            let WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec';
            let USE_LOCAL_MODE = true;
            
            // 除錯日誌
            const debugLog = document.getElementById('debug-log');
            
            // 添加日誌函數
            function addLog(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                if (type === 'error') {
                    logEntry.style.color = '#ff4757';
                } else if (type === 'success') {
                    logEntry.style.color = '#00b894';
                } else if (type === 'warning') {
                    logEntry.style.color = '#ffa94d';
                }
                
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            
            // 在新標籤頁中打開鏈接
            function openInNewTab(url) {
                window.open(url, '_blank');
            }
            
            // 初始化
            function init() {
                addLog('系統初始化中...');
                
                // 加載保存的Web App URL
                const savedUrl = localStorage.getItem('webapp_url');
                if (savedUrl) {
                    document.getElementById('webapp-url').value = savedUrl;
                    document.getElementById('current-url').textContent = savedUrl;
                    document.getElementById('config-url').textContent = savedUrl;
                    WEBAPP_URL = savedUrl;
                    addLog(`已加載保存的Web App URL: ${savedUrl}`);
                    
                    // 測試連接
                    testConnection();
                } else {
                    addLog('未找到保存的Web App URL', 'warning');
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                }
                
                // 添加第一行食材
                addIngredientRow();
                
                // 綁定事件
                document.getElementById('add-ingredient').addEventListener('click', addIngredientRow);
                document.getElementById('save-recipe').addEventListener('click', saveRecipe);
                document.getElementById('reset-form').addEventListener('click', resetForm);
                document.getElementById('load-recipes').addEventListener('click', loadRecipes);
                document.getElementById('save-new-url').addEventListener('click', saveNewWebAppUrl);
                document.getElementById('test-url').addEventListener('click', testUrlValidity);
                document.getElementById('enable-local-mode').addEventListener('click', enableLocalMode);
                document.getElementById('test-connection').addEventListener('click', testConnection);
                document.getElementById('view-localstorage').addEventListener('click', viewLocalStorage);
                document.getElementById('clear-data').addEventListener('click', clearLocalStorage);
                document.getElementById('clear-log').addEventListener('click', clearLog);
                document.getElementById('export-data').addEventListener('click', exportData);
                
                // 標籤切換
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(this.dataset.tab).classList.add('active');
                    });
                });
                
                // 加載食譜
                loadRecipes();
                
                addLog('系統初始化完成');
                addLog('Google Sheets連接失敗，已啟用本地模式', 'warning');
            }
            
            // 更新連接狀態顯示
            function updateConnectionStatus() {
                const statusEl = document.getElementById('connection-status');
                const modeEl = document.getElementById('config-mode');
                
                if (USE_LOCAL_MODE) {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 目前處於離線模式，食譜將保存在本地瀏覽器中';
                    statusEl.className = 'alert warning';
                    modeEl.textContent = '本地模式';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> 已連接到Google Sheets';
                    statusEl.className = 'alert success';
                    modeEl.textContent = 'Google Sheets模式';
                }
            }
            
            // 測試URL有效性
            function testUrlValidity() {
                const testResult = document.getElementById('url-test-result');
                testResult.style.display = 'block';
                testResult.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 測試中...';
                testResult.className = 'alert';
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getRecipes'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        testResult.innerHTML = '<i class="fas fa-check-circle"></i> URL測試成功！可以正常連接到Google Sheets';
                        testResult.className = 'alert success';
                        USE_LOCAL_MODE = false;
                        updateConnectionStatus();
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    testResult.innerHTML = `<i class="fas fa-times-circle"></i> URL測試失敗: ${error.message}`;
                    testResult.className = 'alert error';
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                });
            }
            
            // 保存新的Web App URL
            function saveNewWebAppUrl() {
                const url = document.getElementById('new-webapp-url').value.trim();
                if (!url) {
                    alert('請輸入Web App URL');
                    return;
                }
                
                localStorage.setItem('webapp_url', url);
                WEBAPP_URL = url;
                
                document.getElementById('current-url').textContent = url;
                document.getElementById('config-url').textContent = url;
                
                addLog(`新的Web App URL已保存: ${url}`);
                alert('新的URL已保存！請點擊"測試URL有效性"按鈕驗證連接。');
            }
            
            // 啟用本地模式
            function enableLocalMode() {
                USE_LOCAL_MODE = true;
                updateConnectionStatus();
                addLog('已手動啟用本地模式', 'info');
                alert('已啟用本地模式。食譜將保存在瀏覽器中，直到Google Sheets連接問題解決。');
            }
            
            // 測試連接
            function testConnection() {
                addLog('測試連接到Google Apps Script...');
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getRecipes'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog('連接測試成功', 'success');
                        USE_LOCAL_MODE = false;
                        updateConnectionStatus();
                        alert('連接測試成功！現在可以使用Google Sheets保存食譜。');
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    addLog(`連接測試失敗: ${error.message}`, 'error');
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                    alert(`連接測試失敗: ${error.message}. 系統將使用本地模式。`);
                });
            }
            
            // 添加食材行
            function addIngredientRow() {
                const container = document.getElementById('ingredients-container');
                const row = document.createElement('div');
                row.className = 'ingredient-row';
                
                // 名稱選擇
                const nameSelect = document.createElement('select');
                nameSelect.className = 'name';
                nameSelect.required = true;
                
                // 添加選項
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '選擇食材';
                nameSelect.appendChild(defaultOption);
                
                ingredientOptions.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option;
                    optElement.textContent = option;
                    nameSelect.appendChild(optElement);
                });
                
                // 重量輸入
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.min = '0';
                weightInput.step = 'any';
                weightInput.placeholder = '重量 (克)';
                weightInput.className = 'weight';
                weightInput.required = true;
                
                // 百分比顯示
                const percentInput = document.createElement('input');
                percentInput.type = 'text';
                percentInput.placeholder = '百分比';
                percentInput.className = 'percent';
                percentInput.readOnly = true;
                
                // 說明輸入
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.placeholder = '說明 (可選)';
                descInput.className = 'desc';
                
                // 刪除按鈕
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.onclick = function() {
                    if (document.querySelectorAll('.ingredient-row').length > 1) {
                        row.remove();
                        calculatePercentages();
                    } else {
                        alert('至少需要一種食材');
                    }
                };
                
                // 當名稱選擇變化時
                nameSelect.addEventListener('change', calculatePercentages);
                weightInput.addEventListener('input', calculatePercentages);
                
                // 組合元素
                row.appendChild(nameSelect);
                row.appendChild(weightInput);
                row.appendChild(percentInput);
                row.appendChild(descInput);
                row.appendChild(removeBtn);
                
                container.appendChild(row);
                addLog('已添加食材行');
            }
            
            // 計算百分比
            function calculatePercentages() {
                const rows = document.querySelectorAll('.ingredient-row');
                let flourWeight = 0;
                
                // 首先計算麵粉總重量
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    
                    if (nameSelect.value === '麵粉') {
                        const weight = parseFloat(weightInput.value) || 0;
                        flourWeight += weight;
                    }
                });
                
                // 然後計算每個食材的百分比
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    
                    const weight = parseFloat(weightInput.value) || 0;
                    
                    if (flourWeight === 0) {
                        percentInput.value = '';
                    } else if (nameSelect.value === '麵粉') {
                        percentInput.value = '100%';
                    } else {
                        const percent = (weight / flourWeight * 100).toFixed(2);
                        percentInput.value = percent + '%';
                    }
                });
            }
            
            // 保存食譜
            function saveRecipe() {
                const title = document.getElementById('title').value.trim();
                const steps = document.getElementById('steps').value.trim();
                
                // 驗證表單
                if (!title) {
                    addLog('錯誤: 未填寫食譜名稱', 'error');
                    alert('請填寫食譜名稱');
                    return;
                }
                
                if (!steps) {
                    addLog('錯誤: 未填寫做法步驟', 'error');
                    alert('請填寫做法步驟');
                    return;
                }
                
                // 收集食材數據
                const ingredients = [];
                const rows = document.querySelectorAll('.ingredient-row');
                let hasFlour = false;
                
                for (const row of rows) {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    const descInput = row.querySelector('.desc');
                    
                    const name = nameSelect.value;
                    const weight = parseFloat(weightInput.value);
                    
                    if (!name) {
                        addLog('錯誤: 有食材未選擇名稱', 'error');
                        alert('請選擇食材名稱');
                        return;
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        addLog('錯誤: 有食材重量無效', 'error');
                        alert('請輸入有效的重量');
                        return;
                    }
                    
                    if (name === '麵粉') {
                        hasFlour = true;
                    }
                    
                    ingredients.push({
                        name: name,
                        weight: weight,
                        percent: percentInput.value,
                        desc: descInput.value.trim()
                    });
                }
                
                if (!hasFlour) {
                    addLog('錯誤: 食材中沒有麵粉', 'error');
                    alert('食材中必須包含麵粉，以便計算百分比');
                    return;
                }
                
                if (USE_LOCAL_MODE) {
                    // 本地模式保存
                    saveRecipeToLocalStorage(title, ingredients, steps);
                } else {
                    // Google Sheets模式保存
                    saveRecipeToGoogleSheets(title, ingredients, steps);
                }
            }
            
            // 保存食譜到Google Sheets
            function saveRecipeToGoogleSheets(title, ingredients, steps) {
                addLog(`開始保存食譜到Google Sheets: ${title}`);
                
                // 顯示載入狀態
                const saveButton = document.getElementById('save-recipe');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                saveButton.disabled = true;
                
                // 發送到Google Sheets
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addRecipe',
                        title: title,
                        ingredients: ingredients,
                        steps: steps
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`食譜保存成功: ${title}`, 'success');
                        alert('食譜已成功添加到Google Sheets！');
                        resetForm();
                        loadRecipes();
                    } else {
                        addLog(`食譜保存失敗: ${data.message}`, 'error');
                        alert('錯誤: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLog(`食譜保存失敗: ${error.message}`, 'error');
                    alert('保存失敗，自動切換到本地模式');
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                    saveRecipeToLocalStorage(title, ingredients, steps);
                })
                .finally(() => {
                    // 恢復按鈕狀態
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                });
            }
            
            // 保存食譜到本地存儲
            function saveRecipeToLocalStorage(title, ingredients, steps) {
                addLog(`保存食譜到本地存儲: ${title}`);
                
                // 從本地存儲加載現有食譜
                let recipes = [];
                const storedRecipes = localStorage.getItem('recipes');
                if (storedRecipes) {
                    try {
                        recipes = JSON.parse(storedRecipes);
                    } catch (e) {
                        console.error('Error parsing recipes from localStorage', e);
                    }
                }
                
                // 添加新食譜
                const newRecipe = {
                    title: title,
                    ingredients: ingredients,
                    steps: steps,
                    date: new Date().toLocaleDateString('zh-Hant')
                };
                
                recipes.push(newRecipe);
                
                // 保存回本地存儲
                localStorage.setItem('recipes', JSON.stringify(recipes));
                
                addLog(`食譜已保存到本地存儲: ${title}`, 'success');
                alert('食譜已保存到本地存儲！');
                
                // 更新UI
                resetForm();
                loadRecipes();
            }
            
            // 從Google Sheets加載食譜
            function loadRecipes() {
                if (USE_LOCAL_MODE) {
                    loadRecipesFromLocalStorage();
                    return;
                }
                
                addLog('從Google Sheets加載食譜...');
                
                // 顯示載入狀態
                const recipeList = document.getElementById('recipe-list');
                recipeList.innerHTML = '<div class="alert"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>';
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getRecipes'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`成功加載 ${data.data.length} 個食譜`, 'success');
                        displayRecipes(data.data);
                    } else {
                        addLog(`加載食譜失敗: ${data.message}`, 'error');
                        recipeList.innerHTML = `
                            <div class="alert error">
                                <i class="fas fa-exclamation-circle"></i> 加載食譜失敗: ${data.message}
                            </div>
                        `;
                        // 自動切換到本地模式
                        USE_LOCAL_MODE = true;
                        updateConnectionStatus();
                        loadRecipesFromLocalStorage();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLog(`加載食譜失敗: ${error.message}`, 'error');
                    recipeList.innerHTML = `
                        <div class="alert error">
                            <i class="fas fa-exclamation-circle"></i> 加載食譜失敗，自動切換到本地模式
                        </div>
                    `;
                    // 自動切換到本地模式
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                    loadRecipesFromLocalStorage();
                });
            }
            
            // 從本地存儲加載食譜
            function loadRecipesFromLocalStorage() {
                addLog('從本地存儲加載食譜...');
                
                const recipeList = document.getElementById('recipe-list');
                const storedRecipes = localStorage.getItem('recipes');
                
                if (!storedRecipes) {
                    recipeList.innerHTML = `
                        <div class="alert">
                            <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                        </div>
                    `;
                    document.getElementById('recipe-count').textContent = '0';
                    return;
                }
                
                try {
                    const recipes = JSON.parse(storedRecipes);
                    document.getElementById('recipe-count').textContent = recipes.length;
                    displayRecipes(recipes);
                    addLog(`從本地存儲加載了 ${recipes.length} 個食譜`, 'success');
                } catch (e) {
                    console.error('Error parsing recipes from localStorage', e);
                    recipeList.innerHTML = `
                        <div class="alert error">
                            <i class="fas fa-exclamation-circle"></i> 解析食譜數據時出錯
                        </div>
                    `;
                }
            }
            
            // 顯示食譜列表
            function displayRecipes(recipes) {
                const container = document.getElementById('recipe-list');
                
                if (!recipes || recipes.length === 0) {
                    container.innerHTML = `
                        <div class="alert">
                            <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                        </div>
                    `;
                    document.getElementById('recipe-count').textContent = '0';
                    return;
                }
                
                let html = '';
                
                recipes.forEach((recipe, index) => {
                    let ingredientsHtml = '';
                    
                    // 處理舊格式的食材數據
                    let ingredients = [];
                    if (Array.isArray(recipe.ingredients)) {
                        ingredients = recipe.ingredients;
                    } else if (typeof recipe.ingredients === 'string') {
                        // 嘗試解析舊格式
                        try {
                            ingredients = JSON.parse(recipe.ingredients);
                        } catch (e) {
                            // 如果解析失敗，使用空數組
                            ingredients = [];
                        }
                    }
                    
                    ingredients.forEach(ing => {
                        ingredientsHtml += `
                            <tr>
                                <td>${ing.name || ''}</td>
                                <td>${ing.weight || ''}g</td>
                                <td>${ing.percent || ''}</td>
                                <td>${ing.desc || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        <div class="recipe-card">
                            <div class="recipe-header">
                                <h3 class="recipe-title">${recipe.title}</h3>
                                <span class="recipe-date">${recipe.date || ''}</span>
                            </div>
                            
                            <h4>食材</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>名稱</th>
                                        <th>重量</th>
                                        <th>百分比</th>
                                        <th>說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ingredientsHtml}
                                </tbody>
                            </table>
                            
                            <h4>做法</h4>
                            <div class="steps">${recipe.steps}</div>
                            
                            <button onclick="deleteRecipe(${index})" class="secondary" style="margin-top: 15px;">
                                <i class="fas fa-trash"></i> 刪除食譜
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                document.getElementById('recipe-count').textContent = recipes.length;
            }
            
            // 刪除食譜
            window.deleteRecipe = function(index) {
                if (confirm('確定要刪除此食譜嗎？')) {
                    const storedRecipes = localStorage.getItem('recipes');
                    if (storedRecipes) {
                        try {
                            const recipes = JSON.parse(storedRecipes);
                            recipes.splice(index, 1);
                            localStorage.setItem('recipes', JSON.stringify(recipes));
                            addLog(`已刪除食譜: ${index}`, 'success');
                            loadRecipesFromLocalStorage();
                        } catch (e) {
                            console.error('Error deleting recipe', e);
                            addLog(`刪除食譜失敗: ${e.message}`, 'error');
                        }
                    }
                }
            };
            
            // 重置表單
            function resetForm() {
                document.getElementById('title').value = '';
                document.getElementById('steps').value = '';
                
                const container = document.getElementById('ingredients-container');
                container.innerHTML = '';
                
                addIngredientRow();
                addLog('表單已重置');
            }
            
            // 查看本地存儲
            function viewLocalStorage() {
                addLog('查看本地存儲數據:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    addLog(`${key}: ${value}`);
                }
            }
            
            // 清除本地存儲
            function clearLocalStorage() {
                if (confirm('確定要清除所有本地數據嗎？這將刪除所有保存的食譜和設置。')) {
                    localStorage.clear();
                    addLog('本地存儲已清除', 'success');
                    alert('本地數據已清除');
                    location.reload();
                }
            }
            
            // 導出數據
            function exportData() {
                const storedRecipes = localStorage.getItem('recipes');
                if (!storedRecipes) {
                    alert('沒有數據可導出');
                    return;
                }
                
                try {
                    const recipes = JSON.parse(storedRecipes);
                    const dataStr = JSON.stringify(recipes, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = 'recipes.json';
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    addLog('數據已導出', 'success');
                } catch (e) {
                    console.error('Error exporting data', e);
                    addLog(`導出數據失敗: ${e.message}`, 'error');
                }
            }
            
            // 清除日誌
            function clearLog() {
                debugLog.innerHTML = '';
                addLog('日誌已清除');
            }
            
            // 初始化應用
            init();
        });
    </script>
</body>
</html>
