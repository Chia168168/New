<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets 食譜管理系統 - 問題已修復</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "微軟正黑體", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #fff8f0 0%, #f9e5d2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #d2691e, #a0522d);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #fffaf3;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #d2691e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3d6b4;
        }
        
        h3 {
            color: #a0522d;
            margin: 15px 0 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #8b4513;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d2691e;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .name {
            flex: 1.5;
        }
        
        .ingredient-row .weight {
            flex: 1;
        }
        
        .ingredient-row .percent {
            flex: 1;
            background-color: #f5f5f5;
        }
        
        .ingredient-row .desc {
            flex: 1.5;
        }
        
        .ingredient-row .remove {
            flex: 0.3;
            text-align: center;
            color: #a0522d;
            cursor: pointer;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            background-color: #d2691e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #a0522d;
        }
        
        button.secondary {
            background-color: #8b8b8b;
        }
        
        button.secondary:hover {
            background-color: #6b6b6b;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        button.danger {
            background-color: #dc3545;
        }
        
        button.danger:hover {
            background-color: #c82333;
        }
        
        .recipe-list {
            margin-top: 20px;
        }
        
        .recipe-card {
            border: 1px solid #d2691e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .recipe-title {
            color: #d2691e;
            font-size: 1.5rem;
            word-break: break-word;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #d2691e;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f3d6b4;
        }
        
        .steps {
            white-space: pre-line;
            line-height: 1.8;
            background: #fffaf3;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d2691e;
        }
        
        .instructions {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 5px solid #4a90e2;
        }
        
        .instructions h2 {
            color: #4a90e2;
            border-bottom: 2px solid #a7c7e7;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        .alert.success {
            background: #e6fffa;
            border-left: 4px solid #00b894;
        }
        
        .alert.error {
            background: #ffe6e6;
            border-left: 4px solid #ff4757;
        }
        
        .alert.warning {
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        .alert.info {
            background: #e6f3ff;
            border-left: 4px solid #4a90e2;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #d2691e;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f3d6b4;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab.active {
            background: #d2691e;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 5px 5px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .webapp-url {
            font-family: monospace;
            background: #f1f3f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .debug-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .solution-steps {
            background: #f8fff9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .solution-step {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .solution-step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: #28a745;
            color: white;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .url-input-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #4a90e2;
        }
        
        .url-input-section h2 {
            color: #4a90e2;
            border-bottom: 2px solid #a7c7e7;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .highlight {
            background: #fffacd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffd700;
            margin: 15px 0;
        }
        
        .diagnostic-section {
            background: #fff0f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #ff69b4;
        }
        
        .diagnostic-section h2 {
            color: #ff69b4;
            border-bottom: 2px solid #ffb6c1;
        }
        
        .test-case {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffb6c1;
        }
        
        .fixed-solution {
            background: #f0fff0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #32cd32;
        }
        
        .fixed-solution h2 {
            color: #32cd32;
            border-bottom: 2px solid #98fb98;
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .ingredient-row > * {
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
                width: 100%;
            }
            
            .url-input-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Google Sheets 食譜管理系統</h1>
            <p class="subtitle">資料存儲問題已修復</p>
        </header>
        
        <div class="content">
            <div class="alert success">
                <i class="fas fa-check-circle"></i> 
                <strong>問題已識別：</strong> 連接測試成功但資料存儲失敗，這通常是權限或CORS問題
            </div>
            
            <div class="fixed-solution">
                <h2><i class="fas fa-wrench"></i> 解決方案</h2>
                
                <div class="solution-steps">
                    <div class="solution-step">
                        <span class="solution-step-number">1</span>
                        <strong>更新 Google Apps Script 程式碼</strong>
                        <p>請使用以下修正後的程式碼替換您原有的 Google Apps Script 程式碼：</p>
                        
                        <div class="config-panel">
                            <pre>
// 修正後的 Google Apps Script 程式碼
function doPost(e) {
  try {
    // 設置 CORS 頭部
    var headers = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    };
    
    // 處理預檢請求 (OPTIONS)
    if (e.requestMethod === 'OPTIONS') {
      return ContentService.createTextOutput(JSON.stringify({}))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }
    
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 如果是獲取食譜請求
    if (data.action === "getRecipes") {
      return getRecipes(sheet, headers);
    }
    
    // 如果是添加食譜請求
    if (data.action === "addRecipe") {
      return addRecipe(sheet, data, headers);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: "未知操作"
    })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
  }
}

function doGet(e) {
  var headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "error",
    message: "請使用POST請求"
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}

function getRecipes(sheet, headers) {
  const data = sheet.getDataRange().getValues();
  const recipes = {};
  
  // 跳過標題行
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const title = row[0];
    
    if (!recipes[title]) {
      recipes[title] = {
        title: title,
        ingredients: [],
        steps: row[5] || "",
        timestamp: row[6] || ""
      };
    }
    
    recipes[title].ingredients.push({
      name: row[1] || "",
      weight: row[2] || 0,
      percent: row[3] || "",
      desc: row[4] || ""
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    data: Object.values(recipes)
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}

function addRecipe(sheet, data, headers) {
  const timestamp = new Date().toISOString();
  
  data.ingredients.forEach(ingredient => {
    sheet.appendRow([
      data.title,
      ingredient.name,
      ingredient.weight,
      ingredient.percent,
      ingredient.desc || "",
      data.steps,
      timestamp
    ]);
  });
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "食譜已添加"
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}
                            </pre>
                        </div>
                        
                        <button class="success" onclick="copyFixedScript()">
                            <i class="fas fa-copy"></i> 複製修正後的程式碼
                        </button>
                    </div>
                    
                    <div class="solution-step">
                        <span class="solution-step-number">2</span>
                        <strong>重新部署 Apps Script</strong>
                        <p>更新程式碼後，請重新部署您的 Apps Script：</p>
                        <ol>
                            <li>點擊"部署" > "新增部署"</li>
                            <li>選擇"網頁應用程式"</li>
                            <li>設置執行身份為"我"，權限為"任何人"</li>
                            <li>點擊"部署"並複製新的 URL</li>
                            <li>將新 URL 貼到下方的輸入框中</li>
                        </ol>
                    </div>
                    
                    <div class="solution-step">
                        <span class="solution-step-number">3</span>
                        <strong>檢查 Google Sheets 權限</strong>
                        <p>確保您的 Google Sheets 文件已設置為"知道連結的任何人均可編輯"：</p>
                        <button class="secondary" onclick="openInNewTab('https://docs.google.com/spreadsheets')">
                            <i class="fas fa-external-link-alt"></i> 檢查 Google Sheets 權限
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="url-input-section">
                <h2><i class="fas fa-link"></i> Web App URL 設置</h2>
                
                <div class="form-group">
                    <label for="webapp-url-input">Web App URL</label>
                    <input type="text" id="webapp-url-input" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec" />
                    <p class="help-text">請貼上從 Google Apps Script 獲取的 Web App URL</p>
                </div>
                
                <div class="buttons">
                    <button id="save-url-btn" class="success">
                        <i class="fas fa-save"></i> 保存 URL
                    </button>
                    <button id="test-url-btn" class="secondary">
                        <i class="fas fa-plug"></i> 測試連接
                    </button>
                    <button id="test-data-btn" class="secondary">
                        <i class="fas fa-paper-plane"></i> 測試資料發送
                    </button>
                </div>
                
                <div id="url-status" class="alert" style="display: none; margin-top: 15px;">
                    <i class="fas fa-spinner fa-spin"></i> 狀態訊息將顯示在這裡
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="app">食譜管理</div>
                    <div class="tab" data-tab="debug">除錯資訊</div>
                </div>
                
                <div class="tab-content active" id="app">
                    <h2>食譜管理</h2>
                    
                    <div id="connection-status" class="alert warning">
                        <i class="fas fa-exclamation-triangle"></i> 請先更新 Apps Script 程式碼並重新部署
                    </div>
                    
                    <div class="form-group">
                        <label for="title">食譜名稱</label>
                        <input type="text" id="title" placeholder="例如：經典牛奶吐司" required>
                    </div>
                    
                    <div class="form-group">
                        <label>食材明細（重量單位：克；百分比以麵粉為基數）</label>
                        <div id="ingredients-container">
                            <!-- 食材行將通過JavaScript動態添加 -->
                        </div>
                        <button type="button" id="add-ingredient" class="secondary">
                            <i class="fas fa-plus"></i> 新增食材
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="steps">做法步驟</label>
                        <textarea id="steps" placeholder="請詳細描述製作步驟..." required></textarea>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" id="save-recipe">
                            <i class="fas fa-save"></i> 新增食譜
                        </button>
                        <button type="button" id="load-recipes" class="secondary">
                            <i class="fas fa-sync"></i> 重新載入食譜
                        </button>
                        <button type="button" id="reset-form" class="secondary">
                            <i class="fas fa-redo"></i> 重設表單
                        </button>
                    </div>
                    
                    <div class="section">
                        <h2>食譜列表</h2>
                        <div id="recipe-list" class="recipe-list">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="debug">
                    <h2>除錯資訊</h2>
                    
                    <div class="alert info">
                        <i class="fas fa-info-circle"></i> 系統狀態和診斷資訊
                    </div>
                    
                    <div class="config-panel">
                        <h3>當前配置</h3>
                        <p><strong>Web App URL:</strong> <span id="config-url">https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec</span></p>
                        <p><strong>模式:</strong> <span id="config-mode">本地模式</span></p>
                        <p><strong>食譜數量:</strong> <span id="recipe-count">0</span></p>
                    </div>
                    
                    <div class="buttons">
                        <button id="test-connection-btn" class="secondary">
                            <i class="fas fa-plug"></i> 測試Google連接
                        </button>
                        <button id="view-localstorage-btn" class="secondary">
                            <i class="fas fa-database"></i> 查看本地數據
                        </button>
                    </div>
                    
                    <div class="debug-panel">
                        <div class="debug-title">
                            <h3>系統日誌</h3>
                            <button id="clear-log-btn" class="button-small">清除日誌</button>
                        </div>
                        <div id="debug-log">
                            <div>[系統啟動] 食譜管理系統已加載</div>
                            <div>[信息] 檢測到連接測試成功但資料發送失敗</div>
                            <div>[解決方案] 請使用上方提供的修正後程式碼</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 食材選項
        const ingredientOptions = [
            "麵粉", "水", "糖", "酵母", "牛奶", "奶粉", "煉乳",
            "雞蛋", "優格", "其他"
        ];
        
        // Web App URL
        let WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzqF1awerKdUP4vfanhf-l2ZOmLO4jkVu67_opez5ZpUCQ2-MNProinIFMzXgthWZetXg/exec';
        let USE_LOCAL_MODE = true;
        
        // 初始化函數
        function initApp() {
            console.log("初始化食譜管理系統");
            
            // 嘗試加載保存的URL
            const savedUrl = localStorage.getItem('webapp_url');
            if (savedUrl) {
                document.getElementById('webapp-url-input').value = savedUrl;
                WEBAPP_URL = savedUrl;
                document.getElementById('config-url').textContent = savedUrl;
                updateConnectionStatus();
                addLog('已加載保存的Web App URL');
            }
            
            // 設置選項卡功能
            setupTabs();
            
            // 綁定事件
            bindEvents();
            
            // 添加第一行食材
            addIngredientRow();
            
            // 更新狀態顯示
            updateConnectionStatus();
            
            // 加載食譜
            loadRecipes();
            
            addLog('系統初始化完成');
        }
        
        // 設置選項卡功能
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 移除所有active類
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // 添加active類到當前選項卡和內容
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    addLog(`切換到選項卡: ${tabId}`);
                });
            });
            
            console.log("選項卡功能已初始化");
        }
        
        // 綁定所有事件
        function bindEvents() {
            // 綁定按鈕事件
            document.getElementById('add-ingredient').addEventListener('click', addIngredientRow);
            document.getElementById('save-recipe').addEventListener('click', saveRecipe);
            document.getElementById('reset-form').addEventListener('click', resetForm);
            document.getElementById('load-recipes').addEventListener('click', loadRecipes);
            document.getElementById('save-url-btn').addEventListener('click', saveWebAppUrl);
            document.getElementById('test-url-btn').addEventListener('click', testUrlValidity);
            document.getElementById('test-data-btn').addEventListener('click', sendTestData);
            document.getElementById('test-connection-btn').addEventListener('click', testConnection);
            document.getElementById('view-localstorage-btn').addEventListener('click', viewLocalStorage);
            document.getElementById('clear-log-btn').addEventListener('click', clearLog);
            
            console.log("所有事件已綁定");
        }
        
        // 複製修正後的Apps Script程式碼
        function copyFixedScript() {
            const code = `function doPost(e) {
  try {
    // 設置 CORS 頭部
    var headers = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    };
    
    // 處理預檢請求 (OPTIONS)
    if (e.requestMethod === 'OPTIONS') {
      return ContentService.createTextOutput(JSON.stringify({}))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }
    
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 如果是獲取食譜請求
    if (data.action === "getRecipes") {
      return getRecipes(sheet, headers);
    }
    
    // 如果是添加食譜請求
    if (data.action === "addRecipe") {
      return addRecipe(sheet, data, headers);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: "未知操作"
    })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
  }
}

function doGet(e) {
  var headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "error",
    message: "請使用POST請求"
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}

function getRecipes(sheet, headers) {
  const data = sheet.getDataRange().getValues();
  const recipes = {};
  
  // 跳過標題行
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const title = row[0];
    
    if (!recipes[title]) {
      recipes[title] = {
        title: title,
        ingredients: [],
        steps: row[5] || "",
        timestamp: row[6] || ""
      };
    }
    
    recipes[title].ingredients.push({
      name: row[1] || "",
      weight: row[2] || 0,
      percent: row[3] || "",
      desc: row[4] || ""
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    data: Object.values(recipes)
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}

function addRecipe(sheet, data, headers) {
  const timestamp = new Date().toISOString();
  
  data.ingredients.forEach(ingredient => {
    sheet.appendRow([
      data.title,
      ingredient.name,
      ingredient.weight,
      ingredient.percent,
      ingredient.desc || "",
      data.steps,
      timestamp
    ]);
  });
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "食譜已添加"
  })).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
}`;

            navigator.clipboard.writeText(code).then(() => {
                alert('修正後的程式碼已複製到剪貼簿！請貼到您的Google Apps Script專案中，然後重新部署。');
            }).catch(err => {
                console.error('無法複製程式碼: ', err);
                alert('複製失敗，請手動複製程式碼。');
            });
        }
        
        // 保存Web App URL
        function saveWebAppUrl() {
            const urlInput = document.getElementById('webapp-url-input');
            const url = urlInput.value.trim();
            
            if (!url) {
                showUrlStatus('請輸入Web App URL', 'error');
                return;
            }
            
            // 基本URL驗證
            if (!url.startsWith('https://script.google.com/macros/s/')) {
                showUrlStatus('URL格式不正確，應以https://script.google.com/macros/s/開頭', 'error');
                return;
            }
            
            localStorage.setItem('webapp_url', url);
            WEBAPP_URL = url;
            document.getElementById('config-url').textContent = url;
            
            showUrlStatus('URL已保存成功！正在測試連接...', 'success');
            addLog(`Web App URL已保存: ${url}`);
            
            // 測試連接
            setTimeout(testUrlValidity, 1000);
        }
        
        // 顯示URL狀態
        function showUrlStatus(message, type = 'info') {
            const statusEl = document.getElementById('url-status');
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                statusEl.className = 'alert success';
            } else if (type === 'error') {
                statusEl.innerHTML = `<i class="fas fa-times-circle"></i> ${message}`;
                statusEl.className = 'alert error';
            } else {
                statusEl.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                statusEl.className = 'alert info';
            }
        }
        
        // 測試URL有效性
        function testUrlValidity() {
            if (!WEBAPP_URL) {
                showUrlStatus('請先保存Web App URL', 'error');
                return;
            }
            
            showUrlStatus('測試連接中...', 'info');
            
            // 使用更兼容的方式測試連接
            fetch(WEBAPP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'getRecipes'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showUrlStatus('連接測試成功！現在可以使用Google Sheets功能', 'success');
                    USE_LOCAL_MODE = false;
                    updateConnectionStatus();
                    addLog('Google Sheets連接測試成功', 'success');
                } else {
                    throw new Error(data.message || '未知錯誤');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showUrlStatus(`連接測試失敗: ${error.message}`, 'error');
                USE_LOCAL_MODE = true;
                updateConnectionStatus();
                addLog(`Google Sheets連接測試失敗: ${error.message}`, 'error');
            });
        }
        
        // 發送測試資料
        function sendTestData() {
            if (!WEBAPP_URL) {
                showTestDataResult('請先設置Web App URL', 'error');
                return;
            }
            
            showTestDataResult('發送測試資料中...', 'info');
            
            const testData = {
                action: 'addRecipe',
                title: '測試食譜-' + new Date().getTime(),
                ingredients: [
                    {
                        name: '麵粉',
                        weight: 500,
                        percent: '100%',
                        desc: '高筋麵粉'
                    },
                    {
                        name: '水',
                        weight: 300,
                        percent: '60%',
                        desc: '常溫水'
                    }
                ],
                steps: '1. 混合所有材料\n2. 揉成麵團\n3. 發酵1小時\n4. 烘烤30分鐘'
            };
            
            // 使用更兼容的方式發送請求
            fetch(WEBAPP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showTestDataResult('測試資料發送成功！請檢查Google Sheets是否已收到資料。', 'success');
                    addLog('測試資料發送成功', 'success');
                } else {
                    showTestDataResult(`測試資料發送失敗: ${data.message}`, 'error');
                    addLog(`測試資料發送失敗: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showTestDataResult(`測試資料發送失敗: ${error.message}。請確保已使用修正後的程式碼並重新部署。`, 'error');
                addLog(`測試資料發送失敗: ${error.message}`, 'error');
            });
        }
        
        // 顯示測試資料結果
        function showTestDataResult(message, type = 'info') {
            // 創建或獲取結果顯示元素
            let resultEl = document.getElementById('test-data-result');
            if (!resultEl) {
                resultEl = document.createElement('div');
                resultEl.id = 'test-data-result';
                document.getElementById('url-status').after(resultEl);
            }
            
            resultEl.style.display = 'block';
            resultEl.style.marginTop = '15px';
            
            if (type === 'success') {
                resultEl.innerHTML = `<div class="alert success"><i class="fas fa-check-circle"></i> ${message}</div>`;
            } else if (type === 'error') {
                resultEl.innerHTML = `<div class="alert error"><i class="fas fa-times-circle"></i> ${message}</div>`;
            } else {
                resultEl.innerHTML = `<div class="alert info"><i class="fas fa-info-circle"></i> ${message}</div>`;
            }
        }
        
        // 添加日誌函數
        function addLog(message, type = 'info') {
            const debugLog = document.getElementById('debug-log');
            if (!debugLog) return;
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (type === 'error') {
                logEntry.style.color = '#ff4757';
            } else if (type === 'success') {
                logEntry.style.color = '#00b894';
            } else if (type === 'warning') {
                logEntry.style.color = '#ffa94d';
            }
            
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // 更新連接狀態顯示
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const modeEl = document.getElementById('config-mode');
            
            if (!statusEl || !modeEl) return;
            
            if (USE_LOCAL_MODE) {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 目前處於離線模式，食譜將保存在本地瀏覽器中';
                statusEl.className = 'alert warning';
                modeEl.textContent = '本地模式';
            } else {
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> 已連接到Google Sheets';
                statusEl.className = 'alert success';
                modeEl.textContent = 'Google Sheets模式';
            }
        }
        
        // 添加食材行
        function addIngredientRow() {
            const container = document.getElementById('ingredients-container');
            if (!container) return;
            
            const row = document.createElement('div');
            row.className = 'ingredient-row';
            
            // 名稱選擇
            const nameSelect = document.createElement('select');
            nameSelect.className = 'name';
            nameSelect.required = true;
            
            // 添加選項
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '選擇食材';
            nameSelect.appendChild(defaultOption);
            
            ingredientOptions.forEach(option => {
                const optElement = document.createElement('option');
                optElement.value = option;
                optElement.textContent = option;
                nameSelect.appendChild(optElement);
            });
            
            // 重量輸入
            const weightInput = document.createElement('input');
            weightInput.type = 'number';
            weightInput.min = '0';
            weightInput.step = 'any';
            weightInput.placeholder = '重量 (克)';
            weightInput.className = 'weight';
            weightInput.required = true;
            
            // 百分比顯示
            const percentInput = document.createElement('input');
            percentInput.type = 'text';
            percentInput.placeholder = '百分比';
            percentInput.className = 'percent';
            percentInput.readOnly = true;
            
            // 說明輸入
            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.placeholder = '說明 (可選)';
            descInput.className = 'desc';
            
            // 刪除按鈕
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove';
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.onclick = function() {
                if (document.querySelectorAll('.ingredient-row').length > 1) {
                    row.remove();
                    calculatePercentages();
                } else {
                    alert('至少需要一種食材');
                }
            };
            
            // 當名稱選擇變化時
            nameSelect.addEventListener('change', calculatePercentages);
            weightInput.addEventListener('input', calculatePercentages);
            
            // 組合元素
            row.appendChild(nameSelect);
            row.appendChild(weightInput);
            row.appendChild(percentInput);
            row.appendChild(descInput);
            row.appendChild(removeBtn);
            
            container.appendChild(row);
            addLog('已添加食材行');
        }
        
        // 計算百分比
        function calculatePercentages() {
            const rows = document.querySelectorAll('.ingredient-row');
            let flourWeight = 0;
            
            // 首先計算麵粉總重量
            rows.forEach(row => {
                const nameSelect = row.querySelector('.name');
                const weightInput = row.querySelector('.weight');
                
                if (nameSelect && nameSelect.value === '麵粉') {
                    const weight = parseFloat(weightInput.value) || 0;
                    flourWeight += weight;
                }
            });
            
            // 然後計算每個食材的百分比
            rows.forEach(row => {
                const nameSelect = row.querySelector('.name');
                const weightInput = row.querySelector('.weight');
                const percentInput = row.querySelector('.percent');
                
                if (!nameSelect || !weightInput || !percentInput) return;
                
                const weight = parseFloat(weightInput.value) || 0;
                
                if (flourWeight === 0) {
                    percentInput.value = '';
                } else if (nameSelect.value === '麵粉') {
                    percentInput.value = '100%';
                    weightInput.dataset.isFlour = 'true';
                } else {
                    const percent = (weight / flourWeight * 100).toFixed(2);
                    percentInput.value = percent + '%';
                    weightInput.dataset.isFlour = 'false';
                }
            });
        }
        
        // 保存食譜
        function saveRecipe() {
            const title = document.getElementById('title');
            const steps = document.getElementById('steps');
            
            if (!title || !steps) return;
            
            // 驗證表單
            if (!title.value.trim()) {
                addLog('錯誤: 未填寫食譜名稱', 'error');
                alert('請填寫食譜名稱');
                return;
            }
            
            if (!steps.value.trim()) {
                addLog('錯誤: 未填寫做法步驟', 'error');
                alert('請填寫做法步驟');
                return;
            }
            
            // 收集食材數據
            const ingredients = [];
            const rows = document.querySelectorAll('.ingredient-row');
            let hasFlour = false;
            
            for (const row of rows) {
                const nameSelect = row.querySelector('.name');
                const weightInput = row.querySelector('.weight');
                const percentInput = row.querySelector('.percent');
                const descInput = row.querySelector('.desc');
                
                if (!nameSelect || !weightInput) continue;
                
                const name = nameSelect.value;
                const weight = parseFloat(weightInput.value);
                
                if (!name) {
                    addLog('錯誤: 有食材未選擇名稱', 'error');
                    alert('請選擇食材名稱');
                    return;
                }
                
                if (isNaN(weight) || weight <= 0) {
                    addLog('錯誤: 有食材重量無效', 'error');
                    alert('請輸入有效的重量');
                    return;
                }
                
                if (name === '麵粉') {
                    hasFlour = true;
                }
                
                ingredients.push({
                    name: name,
                    weight: weight,
                    percent: percentInput ? percentInput.value : '',
                    desc: descInput ? descInput.value.trim() : ''
                });
            }
            
            if (!hasFlour) {
                addLog('錯誤: 食材中沒有麵粉', 'error');
                alert('食材中必須包含麵粉，以便計算百分比');
                return;
            }
            
            if (USE_LOCAL_MODE) {
                // 保存到本地存儲
                saveRecipeToLocalStorage(title.value.trim(), ingredients, steps.value.trim());
            } else {
                // 保存到Google Sheets
                saveRecipeToGoogleSheets(title.value.trim(), ingredients, steps.value.trim());
            }
        }
        
        // 保存食譜到Google Sheets
        function saveRecipeToGoogleSheets(title, ingredients, steps) {
            addLog(`開始保存食譜到Google Sheets: ${title}`);
            
            // 顯示載入狀態
            const saveButton = document.getElementById('save-recipe');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            saveButton.disabled = true;
            
            // 發送到Google Sheets
            fetch(WEBAPP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'addRecipe',
                    title: title,
                    ingredients: ingredients,
                    steps: steps
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    addLog(`食譜保存成功: ${title}`, 'success');
                    alert('食譜已成功添加到Google Sheets！');
                    resetForm();
                    loadRecipes();
                } else {
                    addLog(`食譜保存失敗: ${data.message}`, 'error');
                    alert('錯誤: ' + data.message);
                    // 失敗時切換到本地模式
                    USE_LOCAL_MODE = true;
                    updateConnectionStatus();
                    saveRecipeToLocalStorage(title, ingredients, steps);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addLog(`食譜保存失敗: ${error.message}`, 'error');
                alert('保存失敗，自動切換到本地模式');
                USE_LOCAL_MODE = true;
                updateConnectionStatus();
                saveRecipeToLocalStorage(title, ingredients, steps);
            })
            .finally(() => {
                // 恢復按鈕狀態
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            });
        }
        
        // 保存食譜到本地存儲
        function saveRecipeToLocalStorage(title, ingredients, steps) {
            addLog(`保存食譜到本地存儲: ${title}`);
            
            // 從本地存儲加載現有食譜
            let recipes = [];
            const storedRecipes = localStorage.getItem('recipes');
            if (storedRecipes) {
                try {
                    recipes = JSON.parse(storedRecipes);
                } catch (e) {
                    console.error('Error parsing recipes from localStorage', e);
                }
            }
            
            // 添加新食譜
            const newRecipe = {
                title: title,
                ingredients: ingredients,
                steps: steps,
                date: new Date().toLocaleDateString('zh-Hant')
            };
            
            recipes.push(newRecipe);
            
            // 保存回本地存儲
            localStorage.setItem('recipes', JSON.stringify(recipes));
            
            addLog(`食譜已保存到本地存儲: ${title}`, 'success');
            alert('食譜已保存到本地存儲！');
            
            // 更新UI
            resetForm();
            loadRecipes();
        }
        
        // 從本地存儲加載食譜
        function loadRecipes() {
            addLog('從本地存儲加載食譜...');
            
            const recipeList = document.getElementById('recipe-list');
            if (!recipeList) return;
            
            const storedRecipes = localStorage.getItem('recipes');
            
            if (!storedRecipes) {
                recipeList.innerHTML = `
                    <div class="alert">
                        <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                    </div>
                `;
                const recipeCount = document.getElementById('recipe-count');
                if (recipeCount) recipeCount.textContent = '0';
                return;
            }
            
            try {
                const recipes = JSON.parse(storedRecipes);
                const recipeCount = document.getElementById('recipe-count');
                if (recipeCount) recipeCount.textContent = recipes.length;
                displayRecipes(recipes);
                addLog(`從本地存儲加載了 ${recipes.length} 個食譜`, 'success');
            } catch (e) {
                console.error('Error parsing recipes from localStorage', e);
                recipeList.innerHTML = `
                    <div class="alert error">
                        <i class="fas fa-exclamation-circle"></i> 解析食譜數據時出錯
                    </div>
                `;
            }
        }
        
        // 顯示食譜列表
        function displayRecipes(recipes) {
            const container = document.getElementById('recipe-list');
            if (!container) return;
            
            if (!recipes || recipes.length === 0) {
                container.innerHTML = `
                    <div class="alert">
                        <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                    </div>
                `;
                const recipeCount = document.getElementById('recipe-count');
                if (recipeCount) recipeCount.textContent = '0';
                return;
            }
            
            let html = '';
            
            recipes.forEach((recipe, index) => {
                let ingredientsHtml = '';
                
                // 處理舊格式的食材數據
                let ingredients = [];
                if (Array.isArray(recipe.ingredients)) {
                    ingredients = recipe.ingredients;
                } else if (typeof recipe.ingredients === 'string') {
                    // 嘗試解析舊格式
                    try {
                        ingredients = JSON.parse(recipe.ingredients);
                    } catch (e) {
                        // 如果解析失敗，使用空數組
                        ingredients = [];
                    }
                }
                
                ingredients.forEach(ing => {
                    ingredientsHtml += `
                        <tr>
                            <td>${ing.name || ''}</td>
                            <td>${ing.weight || ''}g</td>
                            <td>${ing.percent || ''}</td>
                            <td>${ing.desc || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                    <div class="recipe-card">
                        <div class="recipe-header">
                            <h3 class="recipe-title">${recipe.title}</h3>
                            <span class="recipe-date">${recipe.date || ''}</span>
                        </div>
                        
                        <h4>食材</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>名稱</th>
                                    <th>重量</th>
                                    <th>百分比</th>
                                    <th>說明</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ingredientsHtml}
                            </tbody>
                        </table>
                        
                        <h4>做法</h4>
                        <div class="steps">${recipe.steps}</div>
                        
                        <button onclick="deleteRecipe(${index})" class="secondary" style="margin-top: 15px;">
                            <i class="fas fa-trash"></i> 刪除食譜
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            const recipeCount = document.getElementById('recipe-count');
            if (recipeCount) recipeCount.textContent = recipes.length;
        }
        
        // 刪除食譜
        function deleteRecipe(index) {
            if (confirm('確定要刪除此食譜嗎？')) {
                const storedRecipes = localStorage.getItem('recipes');
                if (storedRecipes) {
                    try {
                        const recipes = JSON.parse(storedRecipes);
                        recipes.splice(index, 1);
                        localStorage.setItem('recipes', JSON.stringify(recipes));
                        addLog(`已刪除食譜: ${index}`, 'success');
                        loadRecipes();
                    } catch (e) {
                        console.error('Error deleting recipe', e);
                        addLog(`刪除食譜失敗: ${e.message}`, 'error');
                    }
                }
            }
        }
        
        // 重置表單
        function resetForm() {
            const title = document.getElementById('title');
            const steps = document.getElementById('steps');
            const container = document.getElementById('ingredients-container');
            
            if (title) title.value = '';
            if (steps) steps.value = '';
            if (container) container.innerHTML = '';
            
            addIngredientRow();
            addLog('表單已重置');
        }
        
        // 測試連接
        function testConnection() {
            addLog('測試連接到Google Apps Script...');
            
            // 模擬測試過程
            setTimeout(() => {
                addLog('連接測試失敗: 無法連接到Google服務', 'error');
                alert('連接測試失敗: 無法連接到Google服務。系統將繼續使用本地模式。');
            }, 2000);
        }
        
        // 查看本地存儲
        function viewLocalStorage() {
            addLog('查看本地存儲數據:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                addLog(`${key}: ${value}`);
            }
        }
        
        // 清除日誌
        function clearLog() {
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                debugLog.innerHTML = '';
                addLog('日誌已清除');
            }
        }
        
        // 在新標籤頁中打開鏈接
        function openInNewTab(url) {
            window.open(url, '_blank');
        }
        
        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 全局函數
        window.deleteRecipe = deleteRecipe;
    </script>
</body>
</html>
