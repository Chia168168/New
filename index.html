<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets 食譜管理系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "微軟正黑體", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #fff8f0 0%, #f9e5d2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #d2691e, #a0522d);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #fffaf3;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #d2691e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3d6b4;
        }
        
        h3 {
            color: #a0522d;
            margin: 15px 0 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #8b4513;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d2691e;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .name {
            flex: 1.5;
        }
        
        .ingredient-row .weight {
            flex: 1;
        }
        
        .ingredient-row .percent {
            flex: 1;
            background-color: #f5f5f5;
        }
        
        .ingredient-row .desc {
            flex: 1.5;
        }
        
        .ingredient-row .remove {
            flex: 0.3;
            text-align: center;
            color: #a0522d;
            cursor: pointer;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            background-color: #d2691e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #a0522d;
        }
        
        button.secondary {
            background-color: #8b8b8b;
        }
        
        button.secondary:hover {
            background-color: #6b6b6b;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        .recipe-list {
            margin-top: 20px;
        }
        
        .recipe-card {
            border: 1px solid #d2691e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .recipe-title {
            color: #d2691e;
            font-size: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #d2691e;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f3d6b4;
        }
        
        .steps {
            white-space: pre-line;
            line-height: 1.8;
            background: #fffaf3;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d2691e;
        }
        
        .instructions {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 5px solid #4a90e2;
        }
        
        .instructions h2 {
            color: #4a90e2;
            border-bottom: 2px solid #a7c7e7;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        .alert.success {
            background: #e6fffa;
            border-left: 4px solid #00b894;
        }
        
        .alert.error {
            background: #ffe6e6;
            border-left: 4px solid #ff4757;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #d2691e;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f3d6b4;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: #d2691e;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .webapp-url {
            font-family: monospace;
            background: #f1f3f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .debug-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #adb5bd;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .ingredient-row > * {
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Google Sheets 食譜管理系統</h1>
            <p class="subtitle">輕鬆管理您的烘焙食譜，自動計算食材百分比</p>
        </header>
        
        <div class="content">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="usage">使用說明</div>
                    <div class="tab" data-tab="setup">Google Sheets設置</div>
                    <div class="tab" data-tab="app">食譜管理</div>
                    <div class="tab" data-tab="debug">除錯資訊</div>
                </div>
                
                <div class="tab-content active" id="usage">
                    <div class="instructions">
                        <h2>如何使用本系統</h2>
                        <ol>
                            <li>首先按照"Google Sheets設置"選項卡中的說明設置您的Google Sheets和Apps Script</li>
                            <li>在"食譜管理"選項卡中填寫食譜名稱</li>
                            <li>添加所有食材，系統會自動計算百分比（以麵粉為100%基準）</li>
                            <li>輸入詳細的做法步驟</li>
                            <li>點擊"新增食譜"按鈕保存到Google Sheets</li>
                            <li>您的食譜將會顯示在下方列表中</li>
                            <li>如果遇到問題，請查看"除錯資訊"選項卡</li>
                        </ol>
                    </div>
                    
                    <div class="alert">
                        <i class="fas fa-info-circle"></i> 
                        <strong>常見問題解決：</strong>
                        <ul>
                            <li>如果"新增食譜"沒有反應，請檢查Web App URL是否正確</li>
                            <li>確保Google Apps Script已部署為"網頁應用程式"</li>
                            <li>權限設置應為"任何人"</li>
                        </ul>
                    </div>
                </div>
                
                <div class="tab-content" id="setup">
                    <h2>Google Sheets 設置指南</h2>
                    
                    <div class="alert">
                        <i class="fas fa-info-circle"></i> 請按照以下步驟設置您的Google Sheets和Apps Script
                    </div>
                    
                    <h3>步驟 1: 創建Google Sheet</h3>
                    <ol>
                        <li>打開 <a href="https://sheets.google.com" target="_blank">Google Sheets</a></li>
                        <li>創建一個新的空白表格</li>
                        <li>將表格命名為"食譜管理"</li>
                        <li>在第一行創建以下列標題：
                            <ul>
                                <li>A列: 食譜名稱</li>
                                <li>B列: 食材名稱</li>
                                <li>C列: 重量 (克)</li>
                                <li>D列: 百分比</li>
                                <li>E列: 說明</li>
                                <li>F列: 做法步驟</li>
                                <li>G列: 時間戳記</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h3>步驟 2: 創建Apps Script</h3>
                    <ol>
                        <li>在Google Sheets中，點擊"擴展功能" > "Apps Script"</li>
                        <li>將預設的程式碼替換為以下代碼：</li>
                    </ol>
                    
                    <div class="config-panel">
                        <pre>
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 如果是獲取食譜請求
    if (data.action === "getRecipes") {
      return getRecipes(sheet);
    }
    
    // 如果是添加食譜請求
    if (data.action === "addRecipe") {
      return addRecipe(sheet, data);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: "未知操作"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: "error",
    message: "請使用POST請求"
  })).setMimeType(ContentService.MimeType.JSON);
}

function getRecipes(sheet) {
  const data = sheet.getDataRange().getValues();
  const recipes = {};
  
  // 跳過標題行
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const title = row[0];
    
    if (!recipes[title]) {
      recipes[title] = {
        title: title,
        ingredients: [],
        steps: row[5] || "",
        timestamp: row[6] || ""
      };
    }
    
    recipes[title].ingredients.push({
      name: row[1] || "",
      weight: row[2] || 0,
      percent: row[3] || "",
      desc: row[4] || ""
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    data: Object.values(recipes)
  })).setMimeType(ContentService.MimeType.JSON);
}

function addRecipe(sheet, data) {
  const timestamp = new Date().toISOString();
  
  data.ingredients.forEach(ingredient => {
    sheet.appendRow([
      data.title,
      ingredient.name,
      ingredient.weight,
      ingredient.percent,
      ingredient.desc || "",
      data.steps,
      timestamp
    ]);
  });
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "食譜已添加"
  })).setMimeType(ContentService.MimeType.JSON);
}
                        </pre>
                    </div>
                    
                    <ol start="3">
                        <li>點擊"保存"按鈕，為項目命名（例如"食譜管理系統"）</li>
                        <li>點擊"部署" > "新增部署"</li>
                        <li>選擇"網頁應用程式"</li>
                        <li>設置執行身份為"我"，權限為"任何人"</li>
                        <li>點擊"部署"</li>
                        <li>複製生成的Web App URL</li>
                        <li>在下面的輸入框中貼上URL：</li>
                    </ol>
                    
                    <div class="form-group">
                        <label for="webapp-url">Web App URL</label>
                        <input type="text" id="webapp-url" placeholder="https://script.google.com/macros/s/..." />
                        <button id="save-url" class="success" style="margin-top: 10px;">
                            <i class="fas fa-save"></i> 保存URL
                        </button>
                    </div>
                    
                    <div class="alert success" id="url-saved-message" style="display: none;">
                        <i class="fas fa-check-circle"></i> URL已保存成功！
                    </div>
                    
                    <div class="alert">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>重要：</strong> 部署後可能需要幾分鐘時間才能生效。如果遇到權限問題，請確保已正確設置"任何人"權限。
                    </div>
                </div>
                
                <div class="tab-content" id="app">
                    <h2>食譜管理</h2>
                    
                    <div id="connection-status" class="alert" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> 檢查連接中...
                    </div>
                    
                    <div class="form-group">
                        <label for="title">食譜名稱</label>
                        <input type="text" id="title" placeholder="例如：經典牛奶吐司" required>
                    </div>
                    
                    <div class="form-group">
                        <label>食材明細（重量單位：克；百分比以麵粉為基數）</label>
                        <div id="ingredients-container">
                            <!-- 食材行將通過JavaScript動態添加 -->
                        </div>
                        <button type="button" id="add-ingredient" class="secondary">
                            <i class="fas fa-plus"></i> 新增食材
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="steps">做法步驟</label>
                        <textarea id="steps" placeholder="請詳細描述製作步驟..." required></textarea>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" id="save-recipe">
                            <i class="fas fa-save"></i> 新增食譜
                        </button>
                        <button type="button" id="load-recipes" class="secondary">
                            <i class="fas fa-sync"></i> 重新載入食譜
                        </button>
                        <button type="button" id="reset-form" class="secondary">
                            <i class="fas fa-redo"></i> 重設表單
                        </button>
                    </div>
                    
                    <div class="section">
                        <h2>食譜列表</h2>
                        <div id="recipe-list" class="recipe-list">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="debug">
                    <h2>除錯資訊</h2>
                    
                    <div class="alert">
                        <i class="fas fa-bug"></i> 如果"新增食譜"沒有反應，請檢查以下資訊：
                    </div>
                    
                    <div class="buttons">
                        <button id="test-connection" class="secondary">
                            <i class="fas fa-plug"></i> 測試連接
                        </button>
                        <button id="view-localstorage" class="secondary">
                            <i class="fas fa-database"></i> 查看保存的數據
                        </button>
                        <button id="clear-data" class="secondary">
                            <i class="fas fa-trash"></i> 清除本地數據
                        </button>
                    </div>
                    
                    <div class="debug-panel">
                        <div class="debug-title">
                            <h3>日誌資訊</h3>
                            <button id="clear-log" class="button-small">清除日誌</button>
                        </div>
                        <div id="debug-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 食材選項
            const ingredientOptions = [
                "麵粉", "水", "糖", "酵母", "牛奶", "奶粉", "煉乳",
                "雞蛋", "優格", "其他"
            ];
            
            // Web App URL
            let WEBAPP_URL = '';
            
            // 除錯日誌
            const debugLog = document.getElementById('debug-log');
            
            // 添加日誌函數
            function addLog(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                if (type === 'error') {
                    logEntry.style.color = '#ff4757';
                } else if (type === 'success') {
                    logEntry.style.color = '#00b894';
                }
                
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            
            // 初始化
            function init() {
                addLog('系統初始化中...');
                
                // 加載保存的Web App URL
                const savedUrl = localStorage.getItem('webapp_url');
                if (savedUrl) {
                    document.getElementById('webapp-url').value = savedUrl;
                    WEBAPP_URL = savedUrl;
                    addLog(`已加載保存的Web App URL: ${savedUrl}`);
                } else {
                    addLog('未找到保存的Web App URL', 'error');
                }
                
                // 添加第一行食材
                addIngredientRow();
                
                // 綁定事件
                document.getElementById('add-ingredient').addEventListener('click', addIngredientRow);
                document.getElementById('save-recipe').addEventListener('click', saveRecipe);
                document.getElementById('reset-form').addEventListener('click', resetForm);
                document.getElementById('load-recipes').addEventListener('click', loadRecipes);
                document.getElementById('save-url').addEventListener('click', saveWebAppUrl);
                document.getElementById('test-connection').addEventListener('click', testConnection);
                document.getElementById('view-localstorage').addEventListener('click', viewLocalStorage);
                document.getElementById('clear-data').addEventListener('click', clearLocalStorage);
                document.getElementById('clear-log').addEventListener('click', clearLog);
                
                // 標籤切換
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(this.dataset.tab).classList.add('active');
                    });
                });
                
                // 嘗試加載食譜
                if (WEBAPP_URL) {
                    testConnection();
                    loadRecipes();
                }
                
                addLog('系統初始化完成');
            }
            
            // 保存Web App URL
            function saveWebAppUrl() {
                const url = document.getElementById('webapp-url').value.trim();
                if (!url) {
                    alert('請輸入Web App URL');
                    return;
                }
                
                localStorage.setItem('webapp_url', url);
                WEBAPP_URL = url;
                
                addLog(`Web App URL已保存: ${url}`);
                
                // 顯示成功消息
                const message = document.getElementById('url-saved-message');
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
                
                // 測試連接
                testConnection();
            }
            
            // 測試連接
            function testConnection() {
                if (!WEBAPP_URL) {
                    addLog('錯誤: 未設置Web App URL', 'error');
                    showConnectionStatus('error', '未設置Web App URL');
                    return;
                }
                
                addLog('測試連接到Google Apps Script...');
                showConnectionStatus('checking', '檢查連接中...');
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getRecipes'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog('連接測試成功', 'success');
                        showConnectionStatus('success', '連接成功');
                    } else {
                        addLog(`連接測試失敗: ${data.message}`, 'error');
                        showConnectionStatus('error', `連接失敗: ${data.message}`);
                    }
                })
                .catch(error => {
                    addLog(`連接測試失敗: ${error.message}`, 'error');
                    showConnectionStatus('error', `連接失敗: ${error.message}`);
                });
            }
            
            // 顯示連接狀態
            function showConnectionStatus(status, message) {
                const statusEl = document.getElementById('connection-status');
                statusEl.style.display = 'block';
                
                if (status === 'checking') {
                    statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
                    statusEl.className = 'alert';
                } else if (status === 'success') {
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                    statusEl.className = 'alert success';
                } else if (status === 'error') {
                    statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    statusEl.className = 'alert error';
                }
            }
            
            // 添加食材行
            function addIngredientRow() {
                const container = document.getElementById('ingredients-container');
                const row = document.createElement('div');
                row.className = 'ingredient-row';
                
                // 名稱選擇
                const nameSelect = document.createElement('select');
                nameSelect.className = 'name';
                nameSelect.required = true;
                
                // 添加選項
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '選擇食材';
                nameSelect.appendChild(defaultOption);
                
                ingredientOptions.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option;
                    optElement.textContent = option;
                    nameSelect.appendChild(optElement);
                });
                
                // 重量輸入
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.min = '0';
                weightInput.step = 'any';
                weightInput.placeholder = '重量 (克)';
                weightInput.className = 'weight';
                weightInput.required = true;
                
                // 百分比顯示
                const percentInput = document.createElement('input');
                percentInput.type = 'text';
                percentInput.placeholder = '百分比';
                percentInput.className = 'percent';
                percentInput.readOnly = true;
                
                // 說明輸入
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.placeholder = '說明 (可選)';
                descInput.className = 'desc';
                
                // 刪除按鈕
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.onclick = function() {
                    if (document.querySelectorAll('.ingredient-row').length > 1) {
                        row.remove();
                        calculatePercentages();
                    } else {
                        alert('至少需要一種食材');
                    }
                };
                
                // 當名稱選擇變化時
                nameSelect.addEventListener('change', calculatePercentages);
                weightInput.addEventListener('input', calculatePercentages);
                
                // 組合元素
                row.appendChild(nameSelect);
                row.appendChild(weightInput);
                row.appendChild(percentInput);
                row.appendChild(descInput);
                row.appendChild(removeBtn);
                
                container.appendChild(row);
                addLog('已添加食材行');
            }
            
            // 計算百分比
            function calculatePercentages() {
                const rows = document.querySelectorAll('.ingredient-row');
                let flourWeight = 0;
                
                // 首先計算麵粉總重量
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    
                    if (nameSelect.value === '麵粉') {
                        const weight = parseFloat(weightInput.value) || 0;
                        flourWeight += weight;
                    }
                });
                
                // 然後計算每個食材的百分比
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    
                    const weight = parseFloat(weightInput.value) || 0;
                    
                    if (flourWeight === 0) {
                        percentInput.value = '';
                    } else if (nameSelect.value === '麵粉') {
                        percentInput.value = '100%';
                    } else {
                        const percent = (weight / flourWeight * 100).toFixed(2);
                        percentInput.value = percent + '%';
                    }
                });
            }
            
            // 保存食譜到Google Sheets
            function saveRecipe() {
                if (!WEBAPP_URL) {
                    addLog('錯誤: 未設置Web App URL', 'error');
                    alert('請先設置Web App URL');
                    document.querySelector('.tab[data-tab="setup"]').click();
                    return;
                }
                
                const title = document.getElementById('title').value.trim();
                const steps = document.getElementById('steps').value.trim();
                
                // 驗證表單
                if (!title) {
                    addLog('錯誤: 未填寫食譜名稱', 'error');
                    alert('請填寫食譜名稱');
                    return;
                }
                
                if (!steps) {
                    addLog('錯誤: 未填寫做法步驟', 'error');
                    alert('請填寫做法步驟');
                    return;
                }
                
                // 收集食材數據
                const ingredients = [];
                const rows = document.querySelectorAll('.ingredient-row');
                let hasFlour = false;
                
                for (const row of rows) {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    const descInput = row.querySelector('.desc');
                    
                    const name = nameSelect.value;
                    const weight = parseFloat(weightInput.value);
                    
                    if (!name) {
                        addLog('錯誤: 有食材未選擇名稱', 'error');
                        alert('請選擇食材名稱');
                        return;
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        addLog('錯誤: 有食材重量無效', 'error');
                        alert('請輸入有效的重量');
                        return;
                    }
                    
                    if (name === '麵粉') {
                        hasFlour = true;
                    }
                    
                    ingredients.push({
                        name: name,
                        weight: weight,
                        percent: percentInput.value,
                        desc: descInput.value.trim()
                    });
                }
                
                if (!hasFlour) {
                    addLog('錯誤: 食材中沒有麵粉', 'error');
                    alert('食材中必須包含麵粉，以便計算百分比');
                    return;
                }
                
                addLog(`開始保存食譜: ${title}`);
                
                // 顯示載入狀態
                const saveButton = document.getElementById('save-recipe');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                saveButton.disabled = true;
                
                // 發送到Google Sheets
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addRecipe',
                        title: title,
                        ingredients: ingredients,
                        steps: steps
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`食譜保存成功: ${title}`, 'success');
                        alert('食譜已成功添加到Google Sheets！');
                        resetForm();
                        loadRecipes();
                    } else {
                        addLog(`食譜保存失敗: ${data.message}`, 'error');
                        alert('錯誤: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLog(`食譜保存失敗: ${error.message}`, 'error');
                    alert('保存失敗，請檢查Web App URL和網絡連接');
                })
                .finally(() => {
                    // 恢復按鈕狀態
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                });
            }
            
            // 從Google Sheets加載食譜
            function loadRecipes() {
                if (!WEBAPP_URL) {
                    addLog('錯誤: 未設置Web App URL', 'error');
                    alert('請先設置Web App URL');
                    document.querySelector('.tab[data-tab="setup"]').click();
                    return;
                }
                
                addLog('從Google Sheets加載食譜...');
                
                // 顯示載入狀態
                const recipeList = document.getElementById('recipe-list');
                recipeList.innerHTML = '<div class="alert"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>';
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getRecipes'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`成功加載 ${data.data.length} 個食譜`, 'success');
                        displayRecipes(data.data);
                    } else {
                        addLog(`加載食譜失敗: ${data.message}`, 'error');
                        recipeList.innerHTML = `
                            <div class="alert error">
                                <i class="fas fa-exclamation-circle"></i> 加載食譜失敗: ${data.message}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLog(`加載食譜失敗: ${error.message}`, 'error');
                    recipeList.innerHTML = `
                        <div class="alert error">
                            <i class="fas fa-exclamation-circle"></i> 加載食譜失敗，請檢查Web App URL和網絡連接
                        </div>
                    `;
                });
            }
            
            // 顯示食譜列表
            function displayRecipes(recipes) {
                const container = document.getElementById('recipe-list');
                
                if (!recipes || recipes.length === 0) {
                    container.innerHTML = `
                        <div class="alert">
                            <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                recipes.forEach((recipe, index) => {
                    let ingredientsHtml = '';
                    
                    recipe.ingredients.forEach(ing => {
                        ingredientsHtml += `
                            <tr>
                                <td>${ing.name}</td>
                                <td>${ing.weight}g</td>
                                <td>${ing.percent}</td>
                                <td>${ing.desc || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        <div class="recipe-card">
                            <div class="recipe-header">
                                <h3 class="recipe-title">${recipe.title}</h3>
                                <span class="recipe-date">${new Date(recipe.timestamp).toLocaleDateString('zh-Hant')}</span>
                            </div>
                            
                            <h4>食材</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>名稱</th>
                                        <th>重量</th>
                                        <th>百分比</th>
                                        <th>說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ingredientsHtml}
                                </tbody>
                            </table>
                            
                            <h4>做法</h4>
                            <div class="steps">${recipe.steps}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // 重置表單
            function resetForm() {
                document.getElementById('title').value = '';
                document.getElementById('steps').value = '';
                
                const container = document.getElementById('ingredients-container');
                container.innerHTML = '';
                
                addIngredientRow();
                addLog('表單已重置');
            }
            
            // 查看本地存儲
            function viewLocalStorage() {
                addLog('查看本地存儲數據:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    addLog(`${key}: ${value}`);
                }
            }
            
            // 清除本地存儲
            function clearLocalStorage() {
                if (confirm('確定要清除所有本地數據嗎？這將刪除保存的Web App URL。')) {
                    localStorage.clear();
                    addLog('本地存儲已清除', 'success');
                    alert('本地數據已清除');
                    location.reload();
                }
            }
            
            // 清除日誌
            function clearLog() {
                debugLog.innerHTML = '';
                addLog('日誌已清除');
            }
            
            // 初始化應用
            init();
        });
    </script>
</body>
</html>
