<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Sheets 食譜管理系統</title>
<style>
  body {
    font-family: "微軟正黑體", "Microsoft JhengHei", Arial, sans-serif;
    max-width: 720px;
    margin: 20px auto;
    background: #fff8f0;
    color: #333;
    padding: 15px 30px;
    border-radius: 8px;
    box-shadow: 0 0 8px #ccc;
  }
  h1, h2 {
    text-align: center;
    color: #d2691e;
  }
  label, select, input, textarea, button {
    font-size: 1rem;
  }
  label {
    margin-top: 15px;
    display: block;
    font-weight: bold;
  }
  select, input[type=number], input[type=text], textarea {
    width: 100%;
    padding: 7px;
    border: 2px solid #d2691e;
    border-radius: 5px;
    box-sizing: border-box;
  }
  textarea { resize: vertical; height: 100px; }
  button {
    margin-top: 20px;
    background-color: #d2691e;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background-color: #a0522d;
  }
  .inline-flex {
    display: flex;
    gap: 10px;
    margin-top: 8px;
  }
  .inline-flex > * {
    flex: 1;
  }
  .button-small {
    flex: 0 0 auto;
    padding: 6px 12px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #d2691e;
    padding: 6px 8px;
    text-align: left;
  }
  th {
    background: #f3d6b4;
  }
</style>
</head>
<body>
<h1>Google Sheets 食譜管理系統</h1>

<form id="recipeForm">
  <label for="title">食譜名稱</label>
  <input type="text" id="title" placeholder="請輸入食譜名稱" required />

  <fieldset style="border:1px solid #d2691e; padding: 12px; border-radius: 5px; margin-top: 15px;">
    <legend style="color:#d2691e; font-weight:bold;">食材明細 (重量單位：克；百分比以麵粉為基數)</legend>
    <div id="ingredientsContainer"></div>
    <button type="button" id="addIngredientBtn">新增食材</button>
  </fieldset>

  <label for="steps" style="margin-top: 20px;">做法步驟</label>
  <textarea id="steps" placeholder="請輸入做法步驟" required></textarea>

  <button type="submit">新增食譜</button>
</form>

<section id="recipeList">
  <h2>食譜列表</h2>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzuzQTeKQuJ4r-xGonM7Dx8dtwrqqWKVlVqx5d9pwUko0qDrFhzpjIuElWCDvEyI1CM/exec'; // 請換成你的 Apps Script Web App URL
  const ingredientOptions = [
    "麵粉", "水", "糖", "酵母", "牛奶", "奶粉", "煉乳",
    "雞蛋", "優格", "其他"
  ];

  function createIngredientRow() {
    const row = document.createElement('div');
    row.className = 'inline-flex';

    const select = document.createElement('select');
    ingredientOptions.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      select.appendChild(option);
    });

    const otherText = document.createElement('input');
    otherText.type = 'text';
    otherText.placeholder = '其他食材名稱';
    otherText.style.display = 'none';

    select.addEventListener('change', () => {
      if (select.value === '其他') {
        otherText.style.display = 'block';
        otherText.required = true;
      } else {
        otherText.style.display = 'none';
        otherText.required = false;
        otherText.value = '';
      }
      calculatePercentages();
    });

    const weightInput = document.createElement('input');
    weightInput.type = 'number';
    weightInput.min = '0';
    weightInput.step = 'any';
    weightInput.placeholder = '重量(克)';
    weightInput.required = true;
    weightInput.addEventListener('input', calculatePercentages);

    const percentInput = document.createElement('input');
    percentInput.type = 'text';
    percentInput.placeholder = '百分比';
    percentInput.readOnly = true;
    percentInput.style.backgroundColor = '#f0f0f0';

    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.placeholder = '說明 (可選)';

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '刪除';
    removeBtn.className = 'button-small';
    removeBtn.style.backgroundColor = '#a0522d';
    removeBtn.style.color = '#fff';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '3px';
    removeBtn.style.cursor = 'pointer';
    removeBtn.onclick = () => {
      row.remove();
      calculatePercentages();
    };

    row.appendChild(select);
    row.appendChild(otherText);
    row.appendChild(weightInput);
    row.appendChild(percentInput);
    row.appendChild(descInput);
    row.appendChild(removeBtn);

    return row;
  }

  function addIngredientRow() {
    const container = document.getElementById('ingredientsContainer');
    const row = createIngredientRow();
    container.appendChild(row);
  }

  function calculatePercentages() {
    const rows = document.getElementById('ingredientsContainer').children;
    let flourWeight = 0;
    for (const row of rows) {
      const select = row.children[0];
      const otherText = row.children[1];
      const weightInput = row.children[2];
      let name = select.value === '其他' ? otherText.value.trim() : select.value;
      if (name === '麵粉') {
        const w = parseFloat(weightInput.value);
        if (!isNaN(w)) flourWeight += w;
      }
    }
    for (const row of rows) {
      const select = row.children[0];
      const otherText = row.children[1];
      const weightInput = row.children[2];
      const percentInput = row.children[3];
      let name = select.value === '其他' ? otherText.value.trim() : select.value;
      const w = parseFloat(weightInput.value);
      if (isNaN(w) || flourWeight === 0) {
        percentInput.value = '';
      } else if (name === '麵粉') {
        percentInput.value = '100%';
      } else {
        percentInput.value = (w / flourWeight * 100).toFixed(2) + '%';
      }
    }
  }

  async function getRecipes() {
    const res = await fetch(WEBAPP_URL + '?action=getRecipes', {method: 'POST'});
    return await res.json();
  }

  async function displayRecipes() {
    const container = document.getElementById('recipeList');
    const recipes = await getRecipes();
    if (!recipes.length) {
      container.innerHTML = '<p>尚無食譜資料</p>';
      return;
    }
    let html = '';
    for (const r of recipes) {
      html += `<h3>${r.title}</h3><strong>食材：</strong><br><table>
        <thead><tr><th>名稱</th><th>重量 (克)</th><th>百分比</th><th>說明</th></tr></thead><tbody>`;
      r.ingredients.forEach(ing => {
        html += `<tr><td>${ing.name}</td><td>${ing.weight}</td><td>${ing.percent}</td><td>${ing.desc || ''}</td></tr>`;
      });
      html += `</tbody></table><strong>做法：</strong><p>${r.steps.replace(/\n/g, '<br>')}</p>`;
    }
    container.innerHTML = html;
  }

  document.getElementById('addIngredientBtn').addEventListener('click', () => {
    addIngredientRow();
  });

  document.getElementById('recipeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    const steps = document.getElementById('steps').value.trim();
    if (!title || !steps) {
      alert('請完整填寫食譜名稱及做法');
      return;
    }
    const rows = document.getElementById('ingredientsContainer').children;
    const ingredients = [];
    let flourExists = false;
    for (const row of rows) {
      const select = row.children[0];
      const otherText = row.children[1];
      const weightInput = row.children[2];
      const percentInput = row.children[3];
      const descInput = row.children[4];

      let name = select.value === '其他' ? otherText.value.trim() : select.value;
      if (!name) {
        alert('請完整填寫所有食材名稱');
        return;
      }
      const weight = parseFloat(weightInput.value);
      if (isNaN(weight) || weight <= 0) {
        alert('請輸入有效的重量數字');
        return;
      }
      if (name === '麵粉') flourExists = true;

      ingredients.push({
        name,
        weight,
        percent: percentInput.value,
        desc: descInput.value.trim()
      });
    }

    if (!flourExists) {
      alert('食材中必須包含麵粉，以便計算百分比');
      return;
    }

    try {
      const res = await fetch(WEBAPP_URL + '?action=addRecipe', {
        method: 'POST',
        body: JSON.stringify({title, ingredients, steps}),
        headers: {'Content-Type': 'application/json'}
      });
      const result = await res.json();
      if (result.status === 'success') {
        alert('食譜新增成功');
        document.getElementById('recipeForm').reset();
        document.getElementById('ingredientsContainer').innerHTML = '';
        addIngredientRow();
        displayRecipes();
      } else {
        alert('新增失敗，請稍後再試');
      }
    } catch (error) {
      alert('新增失敗，請確認網路或服務狀態');
      console.error(error);
    }
  });

  // 初始化
  addIngredientRow();
  displayRecipes();
});
</script>
</body>
</html>
