<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets 食譜管理系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "微軟正黑體", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #fff8f0 0%, #f9e5d2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #d2691e, #a0522d);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #fffaf3;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #d2691e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3d6b4;
        }
        
        h3 {
            color: #a0522d;
            margin: 15px 0 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #8b4513;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d2691e;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .name {
            flex: 1.5;
        }
        
        .ingredient-row .weight {
            flex: 1;
        }
        
        .ingredient-row .percent {
            flex: 1;
            background-color: #f5f5f5;
        }
        
        .ingredient-row .desc {
            flex: 1.5;
        }
        
        .ingredient-row .remove {
            flex: 0.3;
            text-align: center;
            color: #a0522d;
            cursor: pointer;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            background-color: #d2691e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #a0522d;
        }
        
        button.secondary {
            background-color: #8b8b8b;
        }
        
        button.secondary:hover {
            background-color: #6b6b6b;
        }
        
        .recipe-list {
            margin-top: 20px;
        }
        
        .recipe-card {
            border: 1px solid #d2691e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .recipe-title {
            color: #d2691e;
            font-size: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #d2691e;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f3d6b4;
        }
        
        .steps {
            white-space: pre-line;
            line-height: 1.8;
            background: #fffaf3;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d2691e;
        }
        
        .instructions {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 5px solid #4a90e2;
        }
        
        .instructions h2 {
            color: #4a90e2;
            border-bottom: 2px solid #a7c7e7;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background: #fff4e6;
            border-left: 4px solid #ffa94d;
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .ingredient-row > * {
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Google Sheets 食譜管理系統</h1>
            <p class="subtitle">輕鬆管理您的烘焙食譜，自動計算食材百分比</p>
        </header>
        
        <div class="content">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="usage">使用說明</div>
                    <div class="tab" data-tab="setup">Google Sheets設置</div>
                    <div class="tab" data-tab="app">食譜管理</div>
                </div>
                
                <div class="tab-content active" id="usage">
                    <div class="instructions">
                        <h2>如何使用本系統</h2>
                        <ol>
                            <li>首先按照"Google Sheets設置"選項卡中的說明設置您的Google Sheets和Apps Script</li>
                            <li>在"食譜管理"選項卡中填寫食譜名稱</li>
                            <li>添加所有食材，系統會自動計算百分比（以麵粉為100%基準）</li>
                            <li>輸入詳細的做法步驟</li>
                            <li>點擊"新增食譜"按鈕保存到Google Sheets</li>
                            <li>您的食譜將會顯示在下方列表中</li>
                        </ol>
                    </div>
                </div>
                
                <div class="tab-content" id="setup">
                    <h2>Google Sheets 設置指南</h2>
                    
                    <div class="alert">
                        <i class="fas fa-info-circle"></i> 請按照以下步驟設置您的Google Sheets和Apps Script
                    </div>
                    
                    <h3>步驟 1: 創建Google Sheet</h3>
                    <ol>
                        <li>打開 <a href="https://sheets.google.com" target="_blank">Google Sheets</a></li>
                        <li>創建一個新的空白表格</li>
                        <li>將表格命名為"食譜管理"</li>
                        <li>在第一行創建以下列標題：
                            <ul>
                                <li>A列: 食譜名稱</li>
                                <li>B列: 食材名稱</li>
                                <li>C列: 重量 (克)</li>
                                <li>D列: 百分比</li>
                                <li>E列: 說明</li>
                                <li>F列: 做法步驟</li>
                                <li>G列: 時間戳記</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h3>步驟 2: 創建Apps Script</h3>
                    <ol>
                        <li在Google Sheets中，點擊"擴展功能" > "Apps Script"</li>
                        <li>將預設的程式碼替換為以下代碼：</li>
                    </ol>
                    
                    <div class="config-panel">
                        <pre>
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 如果是獲取食譜請求
    if (data.action === "getRecipes") {
      return getRecipes(sheet);
    }
    
    // 如果是添加食譜請求
    if (data.action === "addRecipe") {
      return addRecipe(sheet, data);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: "未知操作"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: "error",
    message: "請使用POST請求"
  })).setMimeType(ContentService.MimeType.JSON);
}

function getRecipes(sheet) {
  const data = sheet.getDataRange().getValues();
  const recipes = {};
  
  // 跳過標題行
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const title = row[0];
    
    if (!recipes[title]) {
      recipes[title] = {
        title: title,
        ingredients: [],
        steps: row[5] || "",
        timestamp: row[6] || ""
      };
    }
    
    recipes[title].ingredients.push({
      name: row[1] || "",
      weight: row[2] || 0,
      percent: row[3] || "",
      desc: row[4] || ""
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    data: Object.values(recipes)
  })).setMimeType(ContentService.MimeType.JSON);
}

function addRecipe(sheet, data) {
  const timestamp = new Date().toISOString();
  
  data.ingredients.forEach(ingredient => {
    sheet.appendRow([
      data.title,
      ingredient.name,
      ingredient.weight,
      ingredient.percent,
      ingredient.desc || "",
      data.steps,
      timestamp
    ]);
  });
  
  return ContentService.createTextOutput(JSON.stringify({
    status: "success",
    message: "食譜已添加"
  })).setMimeType(ContentService.MimeType.JSON);
}
                        </pre>
                    </div>
                    
                    <ol start="3">
                        <li>點擊"保存"按鈕，為項目命名（例如"食譜管理系統"）</li>
                        <li>點擊"部署" > "新增部署"</li>
                        <li>選擇"網頁應用程式"</li>
                        <li>設置執行身份為"我"，權限為"任何人"</li>
                        <li>點擊"部署"</li>
                        <li>複製生成的Web App URL</li>
                        <li>在下面的輸入框中貼上URL：</li>
                    </ol>
                    
                    <div class="form-group">
                        <label for="webapp-url">Web App URL</label>
                        <input type="text" id="webapp-url" placeholder="https://script.google.com/macros/s/..." />
                        <button id="save-url" class="success" style="margin-top: 10px;">
                            <i class="fas fa-save"></i> 保存URL
                        </button>
                    </div>
                    
                    <div class="alert success" id="url-saved-message" style="display: none;">
                        <i class="fas fa-check-circle"></i> URL已保存成功！
                    </div>
                </div>
                
                <div class="tab-content" id="app">
                    <h2>食譜管理</h2>
                    
                    <div class="form-group">
                        <label for="title">食譜名稱</label>
                        <input type="text" id="title" placeholder="例如：經典牛奶吐司" required>
                    </div>
                    
                    <div class="form-group">
                        <label>食材明細（重量單位：克；百分比以麵粉為基數）</label>
                        <div id="ingredients-container">
                            <!-- 食材行將通過JavaScript動態添加 -->
                        </div>
                        <button type="button" id="add-ingredient" class="secondary">
                            <i class="fas fa-plus"></i> 新增食材
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="steps">做法步驟</label>
                        <textarea id="steps" placeholder="請詳細描述製作步驟..." required></textarea>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" id="save-recipe">
                            <i class="fas fa-save"></i> 新增食譜
                        </button>
                        <button type="button" id="load-recipes" class="secondary">
                            <i class="fas fa-sync"></i> 重新載入食譜
                        </button>
                        <button type="button" id="reset-form" class="secondary">
                            <i class="fas fa-redo"></i> 重設表單
                        </button>
                    </div>
                    
                    <div class="section">
                        <h2>食譜列表</h2>
                        <div id="recipe-list" class="recipe-list">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 食材選項
            const ingredientOptions = [
                "麵粉", "水", "糖", "酵母", "牛奶", "奶粉", "煉乳",
                "雞蛋", "優格", "其他"
            ];
            
            // 當前食譜數據
            let recipes = [];
            
            // 初始化
            function init() {
                // 添加第一行食材
                addIngredientRow();
                
                // 綁定事件
                document.getElementById('add-ingredient').addEventListener('click', addIngredientRow);
                document.getElementById('save-recipe').addEventListener('click', saveRecipe);
                document.getElementById('reset-form').addEventListener('click', resetForm);
                
                // 嘗試從本地存儲加載數據
                loadRecipesFromLocalStorage();
            }
            
            // 添加食材行
            function addIngredientRow() {
                const container = document.getElementById('ingredients-container');
                const row = document.createElement('div');
                row.className = 'ingredient-row';
                
                // 名稱選擇
                const nameSelect = document.createElement('select');
                nameSelect.className = 'name';
                nameSelect.required = true;
                
                // 添加選項
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '選擇食材';
                nameSelect.appendChild(defaultOption);
                
                ingredientOptions.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option;
                    optElement.textContent = option;
                    nameSelect.appendChild(optElement);
                });
                
                // 重量輸入
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.min = '0';
                weightInput.step = 'any';
                weightInput.placeholder = '重量 (克)';
                weightInput.className = 'weight';
                weightInput.required = true;
                
                // 百分比顯示
                const percentInput = document.createElement('input');
                percentInput.type = 'text';
                percentInput.placeholder = '百分比';
                percentInput.className = 'percent';
                percentInput.readOnly = true;
                
                // 說明輸入
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.placeholder = '說明 (可選)';
                descInput.className = 'desc';
                
                // 刪除按鈕
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.onclick = function() {
                    if (document.querySelectorAll('.ingredient-row').length > 1) {
                        row.remove();
                        calculatePercentages();
                    } else {
                        alert('至少需要一種食材');
                    }
                };
                
                // 當名稱選擇變化時
                nameSelect.addEventListener('change', calculatePercentages);
                weightInput.addEventListener('input', calculatePercentages);
                
                // 組合元素
                row.appendChild(nameSelect);
                row.appendChild(weightInput);
                row.appendChild(percentInput);
                row.appendChild(descInput);
                row.appendChild(removeBtn);
                
                container.appendChild(row);
            }
            
            // 計算百分比
            function calculatePercentages() {
                const rows = document.querySelectorAll('.ingredient-row');
                let flourWeight = 0;
                
                // 首先計算麵粉總重量
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    
                    if (nameSelect.value === '麵粉') {
                        const weight = parseFloat(weightInput.value) || 0;
                        flourWeight += weight;
                    }
                });
                
                // 然後計算每個食材的百分比
                rows.forEach(row => {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    
                    const weight = parseFloat(weightInput.value) || 0;
                    
                    if (flourWeight === 0) {
                        percentInput.value = '';
                    } else if (nameSelect.value === '麵粉') {
                        percentInput.value = '100%';
                    } else {
                        const percent = (weight / flourWeight * 100).toFixed(2);
                        percentInput.value = percent + '%';
                    }
                });
            }
            
            // 保存食譜
            function saveRecipe() {
                const title = document.getElementById('title').value.trim();
                const steps = document.getElementById('steps').value.trim();
                
                // 驗證表單
                if (!title) {
                    alert('請填寫食譜名稱');
                    return;
                }
                
                if (!steps) {
                    alert('請填寫做法步驟');
                    return;
                }
                
                // 收集食材數據
                const ingredients = [];
                const rows = document.querySelectorAll('.ingredient-row');
                let hasFlour = false;
                
                for (const row of rows) {
                    const nameSelect = row.querySelector('.name');
                    const weightInput = row.querySelector('.weight');
                    const percentInput = row.querySelector('.percent');
                    const descInput = row.querySelector('.desc');
                    
                    const name = nameSelect.value;
                    const weight = parseFloat(weightInput.value);
                    
                    if (!name) {
                        alert('請選擇食材名稱');
                        return;
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        alert('請輸入有效的重量');
                        return;
                    }
                    
                    if (name === '麵粉') {
                        hasFlour = true;
                    }
                    
                    ingredients.push({
                        name: name,
                        weight: weight,
                        percent: percentInput.value,
                        desc: descInput.value.trim()
                    });
                }
                
                if (!hasFlour) {
                    alert('食材中必須包含麵粉，以便計算百分比');
                    return;
                }
                
                // 創建食譜對象
                const recipe = {
                    title: title,
                    ingredients: ingredients,
                    steps: steps,
                    date: new Date().toLocaleDateString('zh-Hant')
                };
                
                // 添加到食譜列表
                recipes.push(recipe);
                
                // 保存到本地存儲
                saveRecipesToLocalStorage();
                
                // 更新顯示
                displayRecipes();
                
                // 重置表單
                resetForm();
                
                alert('食譜已成功添加！');
            }
            
            // 重置表單
            function resetForm() {
                document.getElementById('title').value = '';
                document.getElementById('steps').value = '';
                
                const container = document.getElementById('ingredients-container');
                container.innerHTML = '';
                
                addIngredientRow();
            }
            
            // 顯示食譜列表
            function displayRecipes() {
                const container = document.getElementById('recipe-list');
                
                if (recipes.length === 0) {
                    container.innerHTML = `
                        <div class="alert">
                            <i class="fas fa-info-circle"></i> 尚未添加任何食譜，請使用上方表單新增您的第一個食譜。
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                recipes.forEach((recipe, index) => {
                    let ingredientsHtml = '';
                    
                    recipe.ingredients.forEach(ing => {
                        ingredientsHtml += `
                            <tr>
                                <td>${ing.name}</td>
                                <td>${ing.weight}g</td>
                                <td>${ing.percent}</td>
                                <td>${ing.desc || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                        <div class="recipe-card">
                            <div class="recipe-header">
                                <h3 class="recipe-title">${recipe.title}</h3>
                                <span class="recipe-date">${recipe.date}</span>
                            </div>
                            
                            <h4>食材</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>名稱</th>
                                        <th>重量</th>
                                        <th>百分比</th>
                                        <th>說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ingredientsHtml}
                                </tbody>
                            </table>
                            
                            <h4>做法</h4>
                            <div class="steps">${recipe.steps}</div>
                            
                            <button onclick="deleteRecipe(${index})" class="secondary">
                                <i class="fas fa-trash"></i> 刪除食譜
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // 刪除食譜
            window.deleteRecipe = function(index) {
                if (confirm('確定要刪除此食譜嗎？')) {
                    recipes.splice(index, 1);
                    saveRecipesToLocalStorage();
                    displayRecipes();
                }
            };
            
            // 保存食譜到本地存儲
            function saveRecipesToLocalStorage() {
                localStorage.setItem('recipes', JSON.stringify(recipes));
            }
            
            // 從本地存儲加載食譜
            function loadRecipesFromLocalStorage() {
                const storedRecipes = localStorage.getItem('recipes');
                
                if (storedRecipes) {
                    try {
                        recipes = JSON.parse(storedRecipes);
                        displayRecipes();
                    } catch (e) {
                        console.error('Error loading recipes from localStorage', e);
                    }
                }
            }
            
            // 初始化應用
            init();
        });
    </script>
</body>
</html>
